#!/usr/bin/env pwsh
$ErrorActionPreference = 'SilentlyContinue'
Write-Host "[pre-commit] Validating exchange JSON payloads..."
$jsons = git diff --cached --name-only | Where-Object { $_ -like 'exchange/*.json' -or $_ -like 'exchange/*/*.json' -or $_ -like 'exchange/*/*/*.json' }
if ($jsons) {
  python tools/schema_validator.py $jsons
  if ($LASTEXITCODE -ne 0) {
    Write-Host "[pre-commit] Validation failed. Aborting commit." -ForegroundColor Red
    exit 1
  }

  Write-Host "[pre-commit] Rebuilding ledger index..."
  python tools/ledger_indexer.py --write
  if ($LASTEXITCODE -ne 0) {
    Write-Host "[pre-commit] Ledger indexer failed. Aborting commit." -ForegroundColor Red
    exit 1
  }
  if (Test-Path 'exchange/ledger/index.json') {
    git add exchange/ledger/index.json | Out-Null
  }
}
exit 0
